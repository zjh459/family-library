# 微信小程序云开发迁移到MySQL的步骤

## 准备工作

1. 确保MySQL服务器已安装并运行
2. 创建`bookshelf`数据库: `CREATE DATABASE bookshelf DEFAULT CHARACTER SET utf8mb4`
3. 确认`config.js`中的MySQL连接配置正确

## 基本迁移步骤

### 1. 安装依赖

在根目录和server目录分别执行:
```bash
npm install
```

这将安装必要的依赖，包括Express、MySQL等。

### 2. 导出数据

从微信云开发导出数据有两种方法:

#### 方法一: 使用小程序导出工具页面

1. 在小程序中打开"数据导出"页面 (pages/dataExport/dataExport)
2. 点击"开始导出"，等待导出完成
3. 点击"导出为JSON"，保存导出的文件到`exports`目录
4. 将JSON文件复制到服务器端

#### 方法二: 使用微信云开发后台导出

1. 登录微信云开发控制台
2. 手动导出`categories`和`books`集合
3. 将JSON文件保存到`exports`目录

### 3. 导入数据到MySQL

有两种导入数据的方式:

#### 直接导入JSON文件

```bash
cd tools
node import.js ../exports/books.json ../exports/categories.json
```

#### 先合并再导入

```bash
cd tools 
node combine.js ../exports/books.json ../exports/categories.json ../exports/combined_data.json
node import.js ../exports/combined_data.json
```

### 4. 启动服务器

```bash
cd server
node app.js
```

服务器将在3000端口启动。可通过以下URL验证数据是否导入成功:

- http://localhost:3000/api/categories
- http://localhost:3000/api/books

### 5. 配置小程序

1. 确保`config.js`中的配置指向正确的服务器
2. 将`server.useApi`设置为`true`，启用API模式
3. 重新编译并运行小程序

## 前后端分离部署

如果需要将后端独立部署到服务器，可以使用创建脚本：

```bash
node create-backend.js
```

这将在`backend`目录创建可独立部署的后端项目，包含：
- MySQL配置
- 数据库工具
- 导入工具
- Express服务器
- API接口

### 后端独立部署

将`backend`目录复制到服务器，然后：

```bash
cd backend
npm install
node app.js
```

### 小程序配置

独立部署后，需要：
1. 将`miniprogram/config-template.js`复制为`miniprogram/config.js`
2. 修改`server.url`为服务器实际地址（如`http://106.14.26.102:3000`）
3. 设置`server.useApi`为`true`

## 常见问题

1. **导入数据失败**
   - 检查MySQL连接参数是否正确
   - 检查JSON文件格式
   - 确保导入脚本可访问JSON文件

2. **API连接错误**
   - 检查服务器是否正常运行
   - 确认小程序配置中的服务器URL正确
   - 检查网络环境（微信开发者工具需要忽略域名检查）

3. **数据不同步**
   - 查看导入日志，确认导入是否完整
   - 检查MySQL表结构是否正确

4. **小程序无法连接服务器**
   - 确保服务器允许外部访问
   - 检查防火墙设置，确保3000端口（或自定义端口）开放 